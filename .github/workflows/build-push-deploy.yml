# Required secrets (repository/organization):
#   DOCKER_USER, DOCKER_TOKEN - Docker Hub login
#   DEPLOYMENT_KEY - SSH private key for deploy host
#   DEPLOYMENT_USER - SSH user on deploy host (e.g. root)
#   DEPLOYMENT_HOST, DEPLOYMENT_PORT - deploy server
#   SMTP_HOST, SMTP_PORT, SMTP_SECURE, SMTP_USER, SMTP_PASS, SMTP_FROM, SMTP_TO
# Optional vars (defaults in workflow): SMTP_FROM_NAME, NEXT_PUBLIC_SITE_URL
name: Build, Push and Deploy

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE: codesark/codesark-me
  DEPLOYMENT_DIR: ~/apps/codesark-me

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      sha_short: ${{ steps.set-outputs.outputs.sha_short }}
      branch: ${{ steps.set-outputs.outputs.branch }}
      image_tag: ${{ steps.set-outputs.outputs.image_tag }}
      full_image: ${{ steps.set-outputs.outputs.full_image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure variables
        id: conf
        run: |
          echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set job outputs
        id: set-outputs
        run: |
          echo "sha_short=${{ steps.conf.outputs.sha_short }}" >> $GITHUB_OUTPUT
          echo "branch=${{ steps.conf.outputs.branch }}" >> $GITHUB_OUTPUT
          echo "image_tag=${{ steps.conf.outputs.branch }}-${{ steps.conf.outputs.sha_short }}" >> $GITHUB_OUTPUT
          echo "full_image=${{ env.DOCKER_IMAGE }}:${{ steps.conf.outputs.branch }}-${{ steps.conf.outputs.sha_short }}" >> $GITHUB_OUTPUT

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=raw,value=latest
            type=sha
            type=raw,value=${{ steps.conf.outputs.branch }}
            type=raw,value=${{ steps.conf.outputs.branch }}-${{ steps.conf.outputs.sha_short }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Image info
        run: |
          echo "Successfully pushed images:"
          echo "${{ steps.meta.outputs.tags }}" | while read -r tag; do
            echo "   - $tag"
          done

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && needs.build-and-push.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOYMENT_KEY }}

      - name: Add SSH known hosts
        run: |
          ssh-keyscan -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "mkdir -p ${{ env.DEPLOYMENT_DIR }}"

      - name: Generate docker-compose.yml from template
        run: |
          sed -e "s|\${DOCKER_IMAGE}|${{ needs.build-and-push.outputs.full_image }}|g" \
              docker-compose.prod.yaml > /tmp/docker-compose.yml

      - name: Copy docker-compose.yml to deployment host
        run: |
          scp -P ${{ secrets.DEPLOYMENT_PORT }} \
            /tmp/docker-compose.yml \
            ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_DIR }}/docker-compose.yml

      - name: Create and deploy .env from secrets
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM_NAME: ${{ secrets.SMTP_FROM_NAME }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO: ${{ secrets.SMTP_TO }}
          NEXT_PUBLIC_SITE_URL: ${{ vars.NEXT_PUBLIC_SITE_URL || 'https://codesark.me' }}
        run: |
          {
            echo "SMTP_HOST=${SMTP_HOST}"
            echo "SMTP_PORT=${SMTP_PORT:-587}"
            echo "SMTP_SECURE=${SMTP_SECURE:-false}"
            echo "SMTP_USER=${SMTP_USER}"
            echo "SMTP_PASS=${SMTP_PASS}"
            echo "SMTP_FROM_NAME=${SMTP_FROM_NAME:-codesark.me}"
            echo "SMTP_FROM=${SMTP_FROM}"
            echo "SMTP_TO=${SMTP_TO}"
            echo "NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:-https://codesark.me}"
          } > /tmp/deploy.env
          base64 -w0 /tmp/deploy.env > /tmp/deploy.env.b64
          scp -P ${{ secrets.DEPLOYMENT_PORT }} /tmp/deploy.env.b64 \
            ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_DIR }}/.env.b64
          ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "cd ${{ env.DEPLOYMENT_DIR }} && base64 -d .env.b64 > .env && chmod 600 .env && rm -f .env.b64"

      - name: Login to Docker Hub on deployment host
        run: |
          ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "echo '${{ secrets.DOCKER_TOKEN }}' | docker login ${{ env.DOCKER_REGISTRY }} -u '${{ secrets.DOCKER_USER }}' --password-stdin"

      - name: Check existing deployment
        id: check-existing
        run: |
          if ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "test -f ${{ env.DEPLOYMENT_DIR }}/docker-compose.yml"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Existing docker-compose.yml found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing docker-compose.yml found"
          fi

      - name: Stop existing containers (if running)
        if: steps.check-existing.outputs.exists == 'true'
        run: |
          ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "cd ${{ env.DEPLOYMENT_DIR }} && \
             if docker compose ps -q | grep -q .; then \
               echo 'Stopping existing containers...'; \
               docker compose down --remove-orphans || true; \
             else \
               echo 'No running containers found'; \
             fi"

      - name: Pull Docker image
        run: |
          ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "docker pull ${{ needs.build-and-push.outputs.full_image }}"

      - name: Deploy with docker compose
        run: |
          ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "cd ${{ env.DEPLOYMENT_DIR }} && docker compose up -d --remove-orphans"

      - name: Verify deployment
        run: |
          ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "cd ${{ env.DEPLOYMENT_DIR }} && docker compose ps"

      - name: Check container health
        run: |
          ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "cd ${{ env.DEPLOYMENT_DIR }} && \
             if docker compose ps --format json | grep -q '\"State\":\"running\"'; then \
               echo 'Container is running'; \
             else \
               echo 'Container may not be running properly'; \
               docker compose ps; \
               exit 1; \
             fi"

      - name: Show container logs (if needed)
        if: failure()
        run: |
          ssh -p ${{ secrets.DEPLOYMENT_PORT }} ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }} \
            "cd ${{ env.DEPLOYMENT_DIR }} && docker compose logs --tail=50"

      - name: Deployment info
        run: |
          echo "Successfully deployed:"
          echo "   Image: ${{ needs.build-and-push.outputs.full_image }}"
          echo "   Tag: ${{ needs.build-and-push.outputs.image_tag }}"
          echo "   SHA: ${{ needs.build-and-push.outputs.sha_short }}"
          echo "   Host: ${{ secrets.DEPLOYMENT_USER }}@${{ secrets.DEPLOYMENT_HOST }}"
          echo "   Directory: ${{ env.DEPLOYMENT_DIR }}"
